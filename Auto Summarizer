import os
import re
import json
import yaml
from datetime import datetime

# Directory containing PHP files
PROJECT_DIR = '/path/to/your/project'  # Replace with your actual project path

# Regex patterns to extract key components
CLASS_PATTERN = re.compile(r'class\s+(\w+)')
FUNCTION_PATTERN = re.compile(r'function\s+(\w+)\s*\((.*?)\)')
NAMESPACE_PATTERN = re.compile(r'namespace\s+([\w\\]+)')
COMMENT_PATTERN = re.compile(r'/\*\*(.*?)\*/', re.DOTALL)
CONSTANT_PATTERN = re.compile(r'define\(\s*["\'](\w+)["\']\s*,\s*["\'](.*?)["\']\s*\)')
API_CALL_PATTERN = re.compile(r'(https?://[\w./-]+)')
INCLUDE_PATTERN = re.compile(r'(include|require)(_once)?\s*\(\s*["\'](.*?)["\']\s*\)')


def extract_php_details(file_path):
    with open(file_path, 'r', encoding='utf-8') as file:
        content = file.read()

    namespace = NAMESPACE_PATTERN.search(content)
    class_name = CLASS_PATTERN.search(content)
    functions = FUNCTION_PATTERN.findall(content)
    comments = COMMENT_PATTERN.findall(content)
    constants = CONSTANT_PATTERN.findall(content)
    api_calls = API_CALL_PATTERN.findall(content)
    includes = INCLUDE_PATTERN.findall(content)

    # Extract the first PHPDoc comment as description if available
    description = comments[0].strip().replace('*', '').strip() if comments else "No description available."

    return {
        "file": os.path.basename(file_path),
        "path": file_path,
        "namespace": namespace.group(1) if namespace else "None",
        "class": class_name.group(1) if class_name else "None",
        "description": description,
        "functions": [{"name": fn[0], "parameters": fn[1]} for fn in functions],
        "constants": [{"name": const[0], "value": const[1]} for const in constants],
        "api_calls": api_calls,
        "includes": [inc[2] for inc in includes]
    }


def summarize_project(directory):
    summary = {
        "project": os.path.basename(directory),
        "analyzed_at": datetime.now().isoformat(),
        "files": []
    }
    for root, _, files in os.walk(directory):
        for file in files:
            if file.endswith('.php'):
                file_path = os.path.join(root, file)
                summary["files"].append(extract_php_details(file_path))

    return summary


def save_summary(summary, output_dir='summaries'):
    os.makedirs(output_dir, exist_ok=True)

    # Save as JSON
    json_path = os.path.join(output_dir, 'project_summary.json')
    with open(json_path, 'w', encoding='utf-8') as json_file:
        json.dump(summary, json_file, indent=4, ensure_ascii=False)

    # Save as YAML
    yaml_path = os.path.join(output_dir, 'project_summary.yaml')
    with open(yaml_path, 'w', encoding='utf-8') as yaml_file:
        yaml.dump(summary, yaml_file, default_flow_style=False, allow_unicode=True)

    print(f"âœ… Project summary generated:\n- JSON: {json_path}\n- YAML: {yaml_path}")


if __name__ == "__main__":
    project_summary = summarize_project(PROJECT_DIR)
    save_summary(project_summary)
